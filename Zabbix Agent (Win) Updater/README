Частично автоматизированная процедура централизованного обновления Агентов Zabbix для платформы Windows (x86_64).
Версия: 0.1

Примечания:

* В настройках Агента должно быть разрешено удалённое выполнение команд
* Совместимо c Windows 2008R2 (2008 не проверялась) - Windows 2016 или аналогичными пользовательскими ОС (требуется обязательное наличие POSH любой версии).
* Рассматривается ситуация, когда Агенты обновляются ежедневно, в 15:00 (см. п.3.1, расписание и п. 4.3.4 /st, Start Time)
* Формат архива MSCAB был выбран в силу его универсальности для всех версий Windows
* Желательно (но не обязательно) использовать отдельный шаблон для Агента Windows
* Имена шаблонов и триггеров приведены только для упрощения понимания, у вас они могут отличаться
* Версию 32bit имеет смысл собирать исключительно в том случае, если у вас в парке есть машины с Windows 2008 и на них установлен POSH. В документации рассматривается ситуация, что они у вас есть и POSH там стоит

Краткое описание алгоритма работы:

меняем Макрос версии -> Элемент получает текущую версию Агента хоста -> срабатывает Триггер несовпадения версий -> запускается Action -> скачивается Архив -> шедулится одноразовая Задача -> производится Обновление Агента-> Элемент получает текущую версию Агента хоста -> Триггер более не действителен (установленная версия совпадает с макросной)

Внедрение:

1. Сгенерировать архив Агента в формате CAB
1.1 Скачать из репы скрипт-генератор CAB-архива "CAB"
1.2 Скачать с сайта zabbix.com нужный билд Zabbix, из раздела "Zabbix Sources"
1.3 Распаковать архив, из каталога bin скопировать\перенести в корень скрипта-генератора 2 подкаталога собранных Агентов (win32 и win64), подтвердить замену
1.4 Запустить make_zcab.cmd с обязательным параметром битности (без параметра - справка)

В корне скрипта появится cab-архив с файлами Агента Zabbix соответствующей запросу битности. 
Архив содержит все файлы Агента, кроме файла конфигурации (это именно обновление).

1.5 Полученный архив разместить на сервере Zabbix, в любом удобном месте, доступном через HTTP(S) (например /var/www/html/agents/, https://zbx.domain.com/agents/)

2. Создать (если отсутствует) глобальный макрос "{$ZABBIX_AGENT_VERSION}", присвоить ему номер нового билда Агента (например, 3.4.4)

3. В шаблоне мониторинга Агента Windows (например, "Template_Zabbix_Agent_Win_State")
3.1 Частоту обновления данных элемента agent.version выставить в 15 минут, включить расписание Scheduling = wd1-7h14-16 (7 дней в неделю, с 14:00 до 16:00)
3.2 Отредактировать (или создать, если отсутствует) ВЫКЛЮЧЕННЫЙ триггер устаревания версии Агента: например, "{Template_Zabbix_Agent_State:agent.version.str({$ZABBIX_AGENT_VERSION})}=0"

4. Создать Action "Обновление Агента Zabbix (Windows)" (имя - на ваше усмотрение)
* Default operation step duration = 5m
* Type of calculation = A and B (в реальности фильтров может быть больше)
4.1 В фильтрах выбрать группы Хостов, для которых будет действовать режим автоматического обновления (например, "Host group = Мои Сервера Windows")
4.2 В фильтрах выбрать из шаблона "Template_Zabbix_Agent_Win_State" ранее созданный триггер устаревания: "Trigger = Template_Zabbix_Agent_Win_State: Версия Агента Zabbix устарела"
4.3 В операции добавить Remote command: 
4.3.1 Простое протоколирование (Steps 1-1): cmd /c "@echo %DATE%,%TIME% Outdated Zabbix Agent detected: {ITEM.LASTVALUE}. Replace with {$ZABBIX_AGENT_VERSION}.>>%windir%\temp\zabbix_updater.log"
4.3.2 Скачивание архива (Steps 2-2): if "%PROCESSOR_ARCHITECTURE%" equ "AMD64" powershell -ExecutionPolicy Bypass -Command "& {(New-Object Net.WebClient).DownloadFile('https://zbx.domain.com/agents/zau_64.cab', '%windir%\temp\zau_64.cab')}" 
4.3.4 Установка обновления (Steps 3-3): schtasks /create /tn "ZAU-{$ZABBIX_AGENT_VERSION}" /sc once /st 15:00:00 /et 15:10:00 /ri 0 /ru SYSTEM /rl HIGHEST /z /tr "cmd /c taskkill /f /im zabbix_agentd.exe & extrac32 /e %windir%\temp\zau_64.cab /l \"%ProgramFiles%\zabbix~1\\\" /y & net start \"zabbix agent\""

Если требуется так же обновлять версии 32bit, допустимо создать полный дубликат шагов 3.4.2 (изменить условие детекта битности ОС и поменять название архива) и 3.4.3 (поменять название архива).
