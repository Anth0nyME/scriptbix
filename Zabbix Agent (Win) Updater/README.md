Частично автоматизированная процедура централизованного обновления Агентов Zabbix для платформы Windows (x86_64).
Версия: 0.2

**Информация:**

* В настройках Агента должно быть **разрешено** удалённое выполнение команд
* Совместимо c Windows 2008R2 (2008 не проверялась) по Windows 2016 (или аналогичными пользовательскими ОС, требуется обязательное наличие **POSH** любой версии).
* Рассматривается ситуация, когда Агенты обновляются ежедневно, в 15:00 (см. **п.3.1**, расписание и **п.4.3.4** /st, Start Time)
* Формат архива MSCAB был выбран в силу его универсальности для всех версий Windows
* Желательно (но не обязательно) использовать отдельный шаблон для Агента Windows
* Имена шаблонов и триггеров приведены только для упрощения понимания, у вас они могут и будут отличаться
* Версию 32bit имеет смысл собирать исключительно в том случае, если у вас в парке есть машины с Windows 2008 и на них установлен **POSH**. В документации упоминается ситуация, что они у вас есть и POSH там стоит

**Проблемы:**

Windows 2008 (и R2) не принимает указание **/RI 0** (отключение интервала повтора задания), поэтому для универсальности выполнения на всех ОС 2008-2016 диапазон указывается в явном виде. Однако, поскольку первый запуск задаётся текущим временем до секунд, он в итоге не производится (пропускается сразу при создании задачи).

**ToDo:**

1. Написать скрипт для определения наличия новой версии Агента на сайте zabbix.com, скачивания, распаковки, перепаковки компилированных Агентов Zabbix для Windows в раздельные CAB-архивы и выкладывание их на web-сервер (из ручного останется только изменение макроса, этого мы мартышкам не отдадим (с) х/ф "Гараж").

**Внедрение:**

1. Сгенерировать архив Агента в формате CAB  
    1.1 Скачать из репы скрипт-генератор CAB-архива (каталог **CAB**)  
    1.2 Скачать с сайта zabbix.com нужный билд Zabbix, из раздела "Zabbix Sources"  
    1.3 Распаковать архив, из каталога bin скопировать\перенести в корень скрипта-генератора 2 подкаталога собранных Агентов (win32 и win64), подтвердить замену  
    1.4 Запустить make_zcab.cmd с обязательным параметром битности (без параметра - справка)  

	*В корне скрипта появится cab-архив с файлами Агента Zabbix соответствующей запросу битности.*
	*Архив содержит все файлы Агента, кроме файла конфигурации (это именно обновление).*

	**1.5** Полученный архив разместить на сервере Zabbix, в любом удобном месте, доступном через HTTP(S) (например /var/www/html/agents/, https://zbx.domain.com/agents/)

2. Создать (если отсутствует) глобальный макрос "{$ZABBIX_AGENT_VERSION}", присвоить ему номер нового билда Агента (например, 3.4.4)  

3. В шаблоне мониторинга Агента Windows (например, "Template_Zabbix_Agent_Win")  

	3.1 Частоту обновления данных элемента agent.version выставить в 0, включить Flexible-расписание: Period = 1-7,12:00-16:00, Interval = 15 минут  
	3.2 Отредактировать (или создать, если отсутствует) **ВЫКЛЮЧЕННЫЙ** триггер устаревания версии Агента: например, "{Template_Zabbix_Agent_Win:agent.version.str({$ZABBIX_AGENT_VERSION})}=0"  

4. Создать Action "Обновление Агента Zabbix (Windows)" (имя - на ваше усмотрение)  

	*Default operation step duration = 5m*  
	*Type of calculation = A and B (в реальности фильтров может быть больше)*  

    4.1 В фильтрах выбрать группы Хостов, для которых будет действовать режим автоматического обновления (например, "Host group = Мои Сервера Windows")  
    4.2 В фильтрах выбрать из шаблона "Template_Zabbix_Agent_Win" ранее созданный триггер устаревания: "Trigger = Template_Zabbix_Agent_Win: Версия Агента Zabbix устарела"  
    4.3 В операции добавить Remote command:  
    4.3.1 Простое протоколирование (Steps 1-1): *cmd /c "@echo %DATE%,%TIME% Outdated Zabbix Agent detected: {ITEM.LASTVALUE}. Replace with {$ZABBIX_AGENT_VERSION}.>>%windir%\temp\zabbix_updater.log"*  
    4.3.2 Скачивание архива (Steps 2-2): *if "%PROCESSOR_ARCHITECTURE%" equ "AMD64" powershell -ExecutionPolicy Bypass -Command "& {(New-Object Net.WebClient).DownloadFile('https://zbx.domain.com/agents/zau_64.cab', '%windir%\temp\zau_64.cab')}"*  
    4.3.4 Установка обновления (Steps 3-3): *schtasks /create /TN "ZAU-{$ZABBIX_AGENT_VERSION}" /SC once /ST %time:\~0,8% /ET 15:00:00 /RI 60 /RU SYSTEM /RL HIGHEST /Z /TR "cmd /c taskkill /f /im zabbix_agentd.exe & extrac32 /e %windir%\temp\zau_64.cab /l \"%ProgramFiles%\zabbix~1\\\" /y & net start \"zabbix agent\""*  

	Примечание: Если требуется так же обновлять версии 32bit, допустимо создать полный дубликат шагов 3.4.2 (изменить условие детекта битности ОС и поменять название архива) и 3.4.3 (поменять название архива). Дублированные шаги будут выполняться параллельно.

**Важно:**

Меняйте макрос версии (пункт 2) заранее. Менее, чем за 2 часа до /ET (пункт 4.3.4) и до конца текущих суток макрос менять уже нельзя!

Для Task Scheduler используется трюк /ST %time:~0,8%, который позволяет выполнять задачу **однократно** даже в том случае, если в явном виде указан параметр /RI (первый запуск задачи протухает сразу в момент создания задачи).
Но это накладывает определённое ограничение: триггер на версию Агента (Элемент из пункта 3.1) обязательно должен сработать **не менее, чем за 2 часа** до времени, указанного в /ET.
Если на момент срабатывания шага 3-3 (пункт 4.3.4), добавляющего Задачу в Task Scheduler, разница между текущим временем хоста (параметр /ST) и временем устаревания задачи (параметр /ET) будет **меньше 1 часа** (меньше шага Задачи) - наша задача **не добавится** в расписание!

Краткое описание общего алгоритма:

*Меняем Макрос версии -> получаем текущую версию Агента -> срабатывает Триггер версий -> запускается Action (ширина шагов - 5 минут): скачивается Архив (2-2), добавляется одноразовая Задача в Tasks Scheduler (3-3) -> во время /ET производится Обновление Агента -> получаем текущую версию Агента хоста -> Триггер более не действителен (установленная версия совпадает с макросной)*
